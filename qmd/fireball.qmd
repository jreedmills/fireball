---
title: "Fireball"
author: "Jackson Mills"
format:
  html:
    embed-resources: true
    code-fold: true
    toc: true
execute:
  message: false
  warning: false
  eval: true
---

# Introduction

In this exercise, we will create and showcase a function that simulates the "fireball" spell from Dungeons & Dragons. Dungeons & Dragons (DnD) is a tabletop role-playing game that involves rolling dice to determine outcomes in an imagined fantasy-themed adventure. Combat in DnD often involves spells, which can have a variety of effects on the battlefield depending on the outcomes of associated dice rolls. One such spell, fireball, causes a fiery explosion that affects creatures in the target area. When a character casts fireball, the outcome depends on the results of dice rolls, the caster's difficulty class (DC), the affected creatures' damage immunities, resistances or vulnerabilities, and other modifiers. In order to simulate this, we will create three functions:

-   dice_roll(): A function to simulate rolling different types of dice

-   targets(): A function that creates a dataframe of enemies that will be hit by fireball

-   fireball(): A function that simulates dice rolls and resulting fireball damage for each enemy

-   clean_dead(): A function that will remove dead enemies from the battlefield and remove intermediate information

# Libraries

```{r}

library(tidyverse)
library(dplyr)
library(here)


```

# Dice roll function

The dice_roll() function will take two inputs:

-   n = number of dice to be rolled

-   d = number of sides on each dice (possible values)

It will simulate each dice roll and return the result

```{r}
source(here("R", "dice_roll.R"))
```

# Targets function

The targets() function will create a dataframe representing enemies that will be hit by the fireball spell. The resulting dataframe will include information about the enemies as defined by the following inputs:

-   n = the number of unique enemy types

-   HP = health points of each enemy or enemy type

-   proficiency_bonus = a number that increases some dice rolls

-   ability_modifier = a number that increases some dice rolls

-   name = the name of each enemy or enemy type

-   resistances = types of damage the enemy or enemy type is resistant to

-   vulnerabilities = types of damage the enemy or enemy type is vulnerable to

-   immunities = types of damage the enemy or enemy type is immune to

```{r}
source(here("R", "targets.R"))
```

### Inputs

This function will accept single inputs for single enemy types. For example lets make 10 goblins:

```{r}

goblins <- targets(n = 10, 
                   name = "goblin", 
                   HP = 15, 
                   ability_modifier = 2,
                   proficiency_bonus = 0)

knitr::kable(goblins)

```

We can also enter vector inputs if there are multiple enemy types. For example, lets make 10 goblins and 10 orcs, which have different stats:

```{r}

enemies <- targets(n = c(10,10), 
                name = c("goblin", "orc"), 
                ability_modifier = c(2, 1),
                proficiency_bonus = c(0,0),
                HP = c(15, 25))

knitr::kable(enemies)
```

We can see that the different enemy types have different stats, and are named appropriately (goblin 1, goblin 2, goblin 3, etc.).

# Fireball function

Now that we have our enemies, lets create a function to make them explode! The fireball() function will take the following inputs:

-   targets = dataframe of targets that will be hit by fireball

-   DC = the caster's Difficulty Class (higher DC -\> more likely the spell does more damage)

-   spell_lvl = the level that the caster chooses to cast fireball at (higher spell_lvl -\> more damage)

```{r}

source(here("R", "fireball.R"))

```

Let's test our spell on the goblins and orcs we created before.

```{r}

crispy_enemies <- enemies |>
  fireball()

knitr::kable(crispy_enemies)
```

It looks like something happened, but there's a lot of information. Lets make a new function, clean_dead(), to remove dead enemies from the battlefield and clean up the data.

```{r}

source(here("R", "clean_dead.R"))

crispy_enemies <- crispy_enemies |>
  clean_dead()

knitr::kable(crispy_enemies)

```

We can see that there are 4 goblins and 6 orcs left, indicating that the orcs's extra HP was more beneficial than the goblins extra ability modifier.

Lets create and test fireball on a bunch of enemies with different stats, and plot our results:

```{r}

goblins <- targets(
  n = c(30, 10, 5), 
  HP = c(10, 20, 50), 
  proficiency_bonus = c(1, 0, 0), 
  ability_modifier = c(3, 2, 0),
  name = c("Goblin", "Orc", "Ogre")
) |>
    mutate(army = "Goblin Horde")

demons <- targets(
  n = c(30, 10, 5), 
  HP = c(10, 20, 50), 
  proficiency_bonus = c(0, 1, 0), 
  ability_modifier = c(3, 2, 2),
  name = c("Imp", "Hell Hound", "Demon Lord"),
  resistances = "Fire"
) |>
  mutate(army = "Demonic Legion")

undead <- targets(
  n = c(30, 10, 5),
  HP = c(10, 20, 50),
  proficiency_bonus = c(0, 0, 1),
  ability_modifier = c(0, 0, 2),
  name = c("Zombie", "Ghoul", "Lich")
) |>
  mutate(army = "Undead Swarm")

enemies <- rbind(goblins, demons, undead) |>
  mutate(species = factor(species, levels = c("Goblin", "Orc", "Ogre", "Imp", "Hell Hound", "Demon Lord", "Zombie", "Ghoul", "Lich")),
         army = factor(army, levels = c("Goblin Horde", "Demonic Legion", "Undead Swarm")))

```

```{r}

# Simulate 10,000 fireball scenarios
simulated_fireball <- replicate(1000, fireball(enemies), simplify = FALSE)

# Convert list of dataframes into a single dataframe
fireball_df <- bind_rows(simulated_fireball)

# Optionally, you can filter out hits or crits if you want to look at specific cases
# In this case, we don't have crit functionality, so we'll just work with the damage values.

# Summarize the data by name (average damage per enemy)
summarized_fireball <- fireball_df %>%
  group_by(army, species) %>%
  summarise(
    avg_dmg = mean(dmg),
    .groups = 'drop'
  )

# # Reorder 'species' if necessary to ensure a specific order of bars in the plot
# summarized_fireball$species <- factor(summarized_fireball$species, 
#                                       levels = c("Goblin", "Orc", "Ogre", "Imp", "Hell Hound", "Demon Lord"))  # Example, adjust to your species


# Plot average damage dealt to each target type
ggplot(summarized_fireball, aes(x = species, y = avg_dmg, fill = army)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(
    title = "Average Fireball Damage by Enemy Type (Simulated 10,000 Scenarios)",
    x = "Target",
    y = "Average Damage Taken",
    fill = "Enemy Group"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Goblin Horde" = "yellowgreen", "Demonic Legion" = "firebrick", "Undead Swarm" = "thistle4"))


```

```{r}

# Calculate survival probabilities
survival_probabilities <- fireball_df %>%
  group_by(species, army) %>%
  summarise(
    survival_rate = mean(alive),
    .groups = 'drop'
  )

# Plot survival probabilities
ggplot(survival_probabilities, aes(x = species, y = survival_rate, fill = army)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(
    title = "Survival Probability by Enemy Type (Simulated 10,000 Scenarios)",
    x = "Target Species",
    y = "Survival Probability",
    fill = "Enemy Group"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Goblin Horde" = "yellowgreen", "Demonic Legion" = "firebrick"))

```

```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

# 1. Simulating the Battle Scenario
# Generate 10 different enemies with random attributes
ten_enemies <- targets(n = rep(10, times = 10), 
                   HP = sample(10:60, 10, replace = TRUE), 
                   ability_modifier = sample(-2:3, 10, replace = TRUE),
                   proficiency_bonus = sample(2:5, 10, replace = TRUE), 
                   name = c("Goblin", "Orc", "Troll", "Dragon", "Zombie", "Vampire", "Giant", "Sphinx", "Lich", "Minotaur"),
                   resistances = c("None", "Fire", "None", "Fire", "None", "None", "Fire", "None", "None", "Fire"),
                   vulnerabilities = c("None", "None", "Fire", "None", "Fire", "Fire", "None", "None", "None", "None"),
                   immunities = c("None", "None", "None", "None", "None", "None", "None", "None", "Fire", "None"))

# 2. Apply Fireball Spell to Targets
fireball_results <- fireball(ten_enemies)

# 3. Clean up Dead Targets and Create Data for Visualizations
cleaned_targets <- clean_dead(fireball_results)

# 4. Damage Distribution Plot: Bar plot of damage dealt to each target
damage_plot <- ggplot(fireball_results, aes(x = name, y = dmg, fill = species)) +
  geom_bar(stat = "identity") +
  labs(title = "Damage Dealt by Fireball", x = "Enemy", y = "Damage Dealt") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 5))

# 5. Survival Outcomes Pie Chart: Proportion of enemies who survived or were defeated
survival_outcomes <- fireball_results %>%
  mutate(survival_status = case_when(
    alive == TRUE ~ "Survived",
    alive == FALSE ~ "Defeated",
    TRUE ~ "Unknown"
  ))

survival_plot <- ggplot(survival_outcomes, aes(x = "", fill = survival_status)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") +
  labs(title = "Survival Outcomes After Fireball") +
  theme_void() +
  theme(legend.title = element_blank())

# 6. Before and After HP Comparison
hp_comparison <- fireball_results %>%
  mutate(HP_before = HP + dmg)  # Calculate HP before the damage

hp_comparison_summary <- hp_comparison %>%
  group_by(species) %>%
  summarize(HP_starting = sum(HP_starting), HP = sum(HP)) 

# Create a mapping from enemy names to species
species_labels <- hp_comparison %>%
  group_by(species) %>%
  summarise(label = first(name)) %>%  # Assign one name per species
  deframe()  # Convert to named vector

hp_plot <- ggplot(hp_comparison, aes(x = name, fill = species)) +
  geom_bar(aes(y = HP_starting), stat = "identity", alpha = 0.5) +
  geom_bar(aes(y = HP), stat = "identity", alpha = 0.7) +
  labs(title = "HP Comparison: Before vs After Fireball", 
       x = "Enemy Species", y = "HP") +
  theme_minimal() +
  scale_x_discrete(labels = species_labels) +  # Apply species-level labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 0),
        legend.position = "bottom")  # Adjust label angle and legend position




# Display plots
print(damage_plot)
print(survival_plot)
print(hp_plot)

```
